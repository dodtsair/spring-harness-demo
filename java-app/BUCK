# java-app/BUCK


# ---------------------------------------------------------
# 2) TEST: run Gradle tests, AFTER build
#    srcs = [":gradle-build"] forces Buck to run build first.
# ---------------------------------------------------------
genrule(
    name = "gradle-test",
    out = "test-results",
    cmd = """
        # 1. Load the same image used for building
        docker load -i $(location //build-image:build-kaniko-image)/spring-harness-demo.tar
        
        # 3. Mount source and the PREVIOUS build output (from :gradle-build)
        docker run --rm \
            -v "$(source gradlew):/workspace/gradlew" \
            -v "$(source gradle/wrapper/gradle-wrapper.jar):/workspace/gradle/wrapper/gradle-wrapper.jar" \
            -v "$(source gradle/wrapper/gradle-wrapper.properties):/workspace/gradle/wrapper/gradle-wrapper.properties" \
            -v "$(source build.gradle):/workspace/build.gradle" \
            -v "$(source settings.gradle):/workspace/settings.gradle" \
            -v "$(source src/main):/workspace/src/main" \
            -v "$(source src/test):/workspace/src/test" \
            -v "$(location :gradle-build)/build:/workspace/build" \
            -v "$(location :gradle-build)/build/classes/java/main:/workspace/build/classes/java/main" \
            -v "$(location :gradle-build-tests)/test-classes/java/test:/workspace/build/classes/java/test" \
            -v "$OUT:/output" \
            -w /workspace \
            --entrypoint /bin/sh \
            spring-harness-demo:latest \
            -c '
                set -e
                ./gradlew test --no-daemon --info \
                    -Dorg.gradle.project.buildDir=/workspace/build \
                    --project-cache-dir=/output/.gradle \
                    -PtestResultsDir=/output \
                    -PtestReportDir=/output/reports
                echo "Files in /output inside container:"
                ls -R /output
            '
        false;
    """,
    visibility = ["//..."],
)

# ---------------------------------------------------------
# 3) PACKAGE: create a single JAR file output, AFTER tests
#    It depends on :gradle-test (which depends on :gradle-build).
#    We "carry over" the jar by copying it out of the build/ dir.
# ---------------------------------------------------------
genrule(
    name = "package-jar",
    srcs = [
        # Explicit sources (removed glob)
        "gradlew",
        "gradle/wrapper/gradle-wrapper.jar",
        "gradle/wrapper/gradle-wrapper.properties",
        "build.gradle",
        "settings.gradle",
    ],
    out = "spring-harness-demo.jar",
    cmd = """
        # 1. Load the build container image
        docker load -i $(location //build-image:build-kaniko-image)/spring-harness-demo.tar
                
        # 2. Run Gradle assemble inside the container
        # We mount the classes from :gradle-build to avoid a full re-compile
        docker run --rm \
            -v "$(source gradlew):/workspace/gradlew" \
            -v "$(source gradle/wrapper/gradle-wrapper.jar):/workspace/gradle/wrapper/gradle-wrapper.jar" \
            -v "$(source gradle/wrapper/gradle-wrapper.properties):/workspace/gradle/wrapper/gradle-wrapper.properties" \
            -v "$(source build.gradle):/workspace/build.gradle" \
            -v "$(source settings.gradle):/workspace/settings.gradle" \
            -v "$(source src/main):/workspace/src/main" \
            -v "$(location :gradle-build)/build:/workspace/build" \
            -v "$OUT:/output" \
            -w /workspace \
            --entrypoint /bin/sh \
            spring-harness-demo:latest \
            -c '
            set -e
            # Run assemble. -x test ensures we do not re-run tests.
            # We use the buildDir from the previous step to reuse compiled classes.
            ./gradlew assemble --no-daemon --no-rebuild -x test \
                -Dorg.gradle.project.buildDir=/workspace/build \
                --project-cache-dir=/output/.gradle
            
            # Find the Spring Boot executable JAR and move it to the mounted output
            # By default, Spring Boot produces a fat jar and a "-plain.jar"
            for jar in /workspace/build/libs/*.jar; do
                if [ -f "$jar" ] && ! echo "$jar" | grep -q "\-plain.jar"; then
                    cp "$jar" /output/spring-harness-demo.jar
                    break
                fi
            done
            '
    """,
    visibility = ["//..."],
)


genrule(
    name = "gradle-build-tests",
    out = "test-classes",
    cmd = """
        # 1. Load the container image
        docker load -i $(location //build-image:build-kaniko-image)/spring-harness-demo.tar
                
        # 2. Compile tests using the output of gradle-build as a starting point
        docker run --rm \
            -v "$(source gradlew):/workspace/gradlew" \
            -v "$(source gradle/wrapper/gradle-wrapper.jar):/workspace/gradle/wrapper/gradle-wrapper.jar" \
            -v "$(source gradle/wrapper/gradle-wrapper.properties):/workspace/gradle/wrapper/gradle-wrapper.properties" \
            -v "$(source build.gradle):/workspace/build.gradle" \
            -v "$(source settings.gradle):/workspace/settings.gradle" \
            -v "$(source src/main):/workspace/src/main" \
            -v "$(source src/test):/workspace/src/test" \
            -v "$(location :gradle-build)/build:/workspace/build_ref" \
            -v "$OUT:/workspace/build" \
            -w /workspace \
            --entrypoint /bin/sh \
            spring-harness-demo:latest \
            -c '
            set -e
            # testClasses compiles the test source set. 
            # We point buildDir to the mounted location so it picks up existing main classes.
./gradlew testClasses --no-daemon \
                -Dorg.gradle.project.buildDir=/workspace/build \
                --project-cache-dir=/workspace/build/.gradle            '
    """,
    visibility = ["//..."],
)

# ---------------------------------------------------------
# 1.1) BUILD (Containerized): compile & assemble the JAR (no tests) in container
#    This runs the same build as gradle-build but inside a container
# ---------------------------------------------------------
genrule(
    name = "gradle-build",
    out = "build",
    cmd = """
        # Load the container image
        docker load -i $(location //build-image:build-kaniko-image)/spring-harness-demo.tar
                
        # Run Gradle build inside container using the image's ENTRYPOINT and CMD
        docker run --rm \
            -v "$(source gradlew):/workspace/gradlew" \
            -v "$(source gradle/wrapper/gradle-wrapper.jar):/workspace/gradle/wrapper/gradle-wrapper.jar" \
            -v "$(source gradle/wrapper/gradle-wrapper.properties):/workspace/gradle/wrapper/gradle-wrapper.properties" \
            -v "$(source build.gradle):/workspace/build.gradle" \
            -v "$(source settings.gradle):/workspace/settings.gradle" \
            -v "$(source src/main):/workspace/src/main" \
            -v "$OUT:/workspace/build" \
            -w /workspace \
            --entrypoint /bin/sh \
            spring-harness-demo:latest \
            -c '
                ./gradlew testClasses --no-daemon \
                    -Dorg.gradle.project.buildDir=/workspace/build \
                    --project-cache-dir=/workspace/build/.gradle;
            ';
        """,
    visibility = ["//..."],
)


# java-app/BUCK

genrule(
    name = "gradle-all-in-one",
    srcs = [
        "gradlew",
        "gradle/wrapper/gradle-wrapper.jar",
        "gradle/wrapper/gradle-wrapper.properties",
        "build.gradle",
        "settings.gradle",
    ],
    # We output a directory containing both the JAR and the test reports
    out = "gradle-out",
    cmd = """
        # 1. Load the build container image
        docker load -i $(location //build-image:build-kaniko-image)/spring-harness-demo.tar
                
        # 2. Run everything in one shot
        # We mount the entire project root to /workspace
        docker run --rm \
            -v "$(source gradlew):/workspace/gradlew" \
            -v "$(source gradle/wrapper/gradle-wrapper.jar):/workspace/gradle/wrapper/gradle-wrapper.jar" \
            -v "$(source gradle/wrapper/gradle-wrapper.properties):/workspace/gradle/wrapper/gradle-wrapper.properties" \
            -v "$(source build.gradle):/workspace/build.gradle" \
            -v "$(source settings.gradle):/workspace/settings.gradle" \
            -v "$(source src):/workspace/src" \
            -v "$OUT:/workspace/build" \
            -w /workspace \
            --entrypoint /bin/sh \
            spring-harness-demo:latest \
            -c '
                set -e
                # Run build (compile + test + assemble)
                ./gradlew build --no-daemon \
                    -Dorg.gradle.project.buildDir=/workspace/build \
                    --project-cache-dir=/workspace/build/.gradle
            '
    """,
    visibility = ["//..."],
)