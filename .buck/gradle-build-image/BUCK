# .buck/gradle-build-image/BUCK

genrule(
    name = "gradle-build-image",
    out = "gradle-build-image.tar",
    srcs = [
        "kaniko-workspace",
        "//melange:build-apks",
        "//melange:generate-keys",
    ],
    env = {
        "PROJECT_DIR": native.package_name()[len(".buck/"):],
        "STEP_IMAGE": "gcr.io/kaniko-project/executor:latest",
        "STEP_ACTION":
            "--dockerfile=.buck/" + native.package_name()[len(".buck/"):] + "/kaniko-workspace/Dockerfile " +
            "--context=dir://. " +
            "--destination=gradle-build-image:latest " +
            "--tarPath=build/" + native.package_name()[len(".buck/"):] + "/gradle-build-image.tar " +
            "--no-push ",
    },
    cmd = """
        docker run --rm \
          -v "$OUT:/workspace/build/$PROJECT_DIR" \
          -v "$(source kaniko-workspace):/workspace/.buck/$PROJECT_DIR/kaniko-workspace:ro" \
          -v "$(location //melange:build-apks):/workspace/build/melange/apks:ro" \
          -v "$(location //melange:generate-keys):/workspace/build/melange/keys:ro" \
          -w "/workspace/" \
          $STEP_IMAGE $STEP_ACTION
    """,
    visibility = ["//..."],
)

genrule(
    name = "load-gradle-image",
    out = "load_sentinel.txt",
    srcs = [
        ":gradle-build-image",
    ],
    env = {
        "PROJECT_DIR": native.package_name()[len(".buck/"):],
        "STEP_IMAGE": "docker:latest",
        "STEP_ACTION":
            "load -i build/" + native.package_name()[len(".buck/"):] + "/gradle-build-image.tar",
    },
    cmd = """
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v "$(location :gradle-build-image):/workspace/build/$PROJECT_DIR/gradle-build-image.tar:ro" \
          -w "/workspace/build/$PROJECT_DIR" \
          $STEP_IMAGE $STEP_ACTION

        echo "done" > "$OUT/load_sentinel.txt"
    """,
    visibility = ["//..."],
)
